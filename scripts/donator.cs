//Donors
$Farming::MaxPlayers = 42;
$isDonator_["blid"] = 1 TAB "comment here";

$isVIP_["4928"]		= 1 TAB "Conan";
$isVIP_["33152"]	= 1 TAB "Trinko";
$isVIP_["1768"]		= 1 TAB "Zeustal";
$isVIP_["691"]		= 1 TAB "Boltster";
$isVIP_["12027"]	= 1 TAB "Sentry";
$isVIP_["4382"]		= 1 TAB "Skill4Life";
$isVIP_["2227"]		= 1 TAB "The Brighter Dark";
$isVIP_["10661"]	= 1 TAB "Dart";
$isVIP_["51914"]	= 1 TAB "MARBLE MAN";
$isVIP_["9373"]		= 1 TAB "Smallguy";
$isVIP_["33468"]	= 1 TAB "Wolfly";
$isVIP_["12953"]	= 1 TAB "irrel";
$isVIP_["263963"]	= 1 TAB "irrel_";
$isVIP_["27312"]	= 1 TAB "FlavouredGames";
$isVIP_["46426"]	= 1 TAB "Monoblaster";
$isVIP_["2213"]		= 1 TAB "Carbon Zypher / Darksaber2213";

$isDonator_["4928"]		= 1 TAB "Conan";
$isDonator_["53456"]	= 1 TAB "celau";
$isDonator_["20061"]	= 1 TAB "Cavik";
$isDonator_["378"]		= 1 TAB "Sylvanor";
$isDonator_["49865"]	= 1 TAB "Jasa";
$isDonator_["14516"]	= 1 TAB "ExecPaper";
$isDonator_["36965"]	= 1 TAB "Element";
$isDonator_["12027"]	= 1 TAB "Sentry";
$isDonator_["23751"]	= 1 TAB "Shy_Guy";
$isDonator_["3306"]		= 1 TAB "Mr.LoL";
$isDonator_["256895"]	= 1 TAB "YetiBTW";
$isDonator_["42119"]	= 1 TAB "Motortruck";
$isDonator_["3898"]		= 1 TAB "The Titanium (Donator but only wants join/reroll perks)";
$isDonator_["33688"]	= 1 TAB "Redconer";
$isDonator_["5518"]		= 1 TAB "L";
$isDonator_["27312"]	= 1 TAB "FlavouredGames";
$isDonator_["26315"]	= 1 TAB "dahscout";
$isDonator_["4382"]		= 1 TAB "Skill4Life";
$isDonator_["257754"]	= 1 TAB "jessica/pumbis";
$isDonator_["256218"]	= 1;
$isDonator_["37468"]	= 1 TAB "Razer";
$isDonator_["8584"]		= 1 TAB "Pandan";
$isDonator_["216258"]	= 1 TAB "butterninja";
$isDonator_["3636"]		= 1;
$isDonator_["187278"]	= 1 TAB "brib (borb in discord)";
$isDonator_["28317"]	= 1 TAB "Kraiyick";
$isDonator_["9374"]		= 1 TAB "Aware";
$isDonator_["16788"]	= 1 TAB "xLEGOx";
$isDonator_["14329"]	= 1 TAB "Gothboy";
$isDonator_["12247"]	= 1 TAB "Pah1023";
$isDonator_["39002"]	= 1 TAB "Lomby/Redd";
$isDonator_["51892"]	= 1 TAB "just:center";
$isDonator_["2213"]		= 1 TAB "Carbon Zypher / Darksaber2213";
$isDonator_["210164"]	= 1 TAB "Jerry McLarry";
$isDonator_["39617"]	= 1 TAB "Queuenard";
$isDonator_["259928"]	= 1 TAB "_=Conner=_";
$isDonator_["264855"]	= 1 TAB "Betel";
$isDonator_["263061"]	= 1 TAB "Bricksmith/Scepter";
$isDonator_["27086"]	= 1 TAB "Scepter/Bricksmith";
$isDonator_["31470"]	= 1 TAB "Fastmapler";
$isDonator_["1768"]		= 1 TAB "Zeustal";
$isDonator_["49703"]	= 1 TAB "Radio Star";
$isDonator_["21542"]	= 1 TAB "Subject";
$isDonator_["6052"]		= 1 TAB "Sauce";
$isDonator_["166053"]	= 1 TAB "Gentle Spy";
$isDonator_["6835"]		= 1 TAB "SadBlobFish";
$isDonator_["41812"]	= 1 TAB "meesh";
$isDonator_["262122"]	= 1 TAB "[Fridge Raider]";
$isDonator_["9887"]		= 1 TAB "SomeOod";
$isDonator_["176770"]	= 1 TAB "Siffren";
$isDonator_["82190"]	= 1 TAB "marco";
$isDonator_["40407"]	= 1 TAB "Macstroyer";
$isDonator_["183926"]	= 1 TAB "Inco";
$isDonator_["32164"]	= 1 TAB "WileyCoyote";
$isDonator_["2072"]		= 1 TAB "Johnny (^ (gifted by jerry)";
$isDonator_["263963"]	= 1 TAB "irrel (gifted by jerry)";
$isDonator_["28116"]	= 1 TAB "Buddy (gifted by jerry)";
$isDonator_["188659"]	= 1 TAB "PK Freeze (gifted by jerry)";
$isDonator_["44574"]	= 1 TAB "Mr Queeba";
$isDonator_["28626"]	= 1 TAB "Bristem";
$isDoantor_["46426"]	= 1 TAB "Monoblaster";
$isDonator_["168002"]	= 1 TAB "Hydrak";
$isDonator_["4785"]		= 1 TAB "Pacer";
$isDonator_["6052"]		= 1 TAB "Sauce (part 2)";
$isDonator_["219047"]	= 1 TAB "Agster (gifted by Sauce)";

$isBetaTester_["30881"]		= 1 TAB "Allun Pentax";
$isBetaTester_["39617"]		= 1 TAB "Queuenard";
$isBetaTester_["155122"]	= 1 TAB "";
$isBetaTester_["53456"]		= 1 TAB "celau";
$isBetaTester_["35003"]		= 1 TAB "Qube?";
$isBetaTester_["46098"]		= 1 TAB "";
$isBetaTester_["10661"]		= 1 TAB "Dart";
$isBetaTester_["3180"]		= 1 TAB "";
$isBetaTester_["3636"]		= 1 TAB "";
$isBetaTester_["14610"]		= 1 TAB "";
$isBetaTester_["28116"]		= 1 TAB "";
$isBetaTester_["27312"]		= 1 TAB "FlavouredGames";
$isBetaTester_["52730"]		= 1 TAB "";
$isBetaTester_["33688"]		= 1 TAB "Redconer";
$isBetaTester_["21824"]		= 1 TAB "";
$isBetaTester_["256895"]	= 1 TAB "YetiBTW";
$isBetaTester_["49862"]		= 1 TAB "";
$isBetaTester_["203441"]	= 1 TAB "";
$isBetaTester_["691"]		= 1 TAB "Boltster";
$isBetaTester_["32598"]		= 1 TAB "Nozero";
$isBetaTester_["33152"]		= 1 TAB "Trinko";
$isBetaTester_["12027"]		= 1 TAB "Sentry";
$isBetaTester_["4342"]		= 1 TAB "NEkram";
$isBetaTester_["9373"]		= 1 TAB "Smallguy";
$isBetaTester_["4382"]		= 1 TAB "Skill4Life";
$isBetaTester_["166680"]	= 1 TAB "Wetback/Nothing";



function checkIfDonator(%bl_id)
{
	return $isDonator_[%bl_id];
}

function checkIfBetaTester(%bl_id)
{
	return $isBetaTester_[%bl_id];
}

function checkIfVIP(%bl_id)
{
	return $isVIP_[%bl_id];
}

function makeDonator(%bl_id)
{
	%client = findClientByBL_ID(%bl_id);
	%client.isDonator = 1;
	%client.canWearHats = 1;
	%client.canRefreshDeal = 1;
}

function applyDonatorSettings(%cl)
{
	// %cl.messagePrefix = "<shadow:4:4><shadowcolor:303030><color:ffffff>";
	%cl.canWearHats = 1;
	%cl.canRefreshDeal = 1;

	if (%cl.name !$= "The Titanium" && %cl.name !$= "Conan")
	{
		%cl.isDonator = 1;
		%cl.shapeNameColor = "0.95 0.85 0";
		if (isObject(%cl.player))
		{
			%cl.player.setShapeNameColor(%cl.shapeNameColor);
		}
		if (%cl.bl_id == 3306)
			messageAll('', "<bitmap:base/client/ui/ci/star> \c3" @ %cl.name @ "\c6 is French! Hon hon hon!");
		else
			messageAll('', "<bitmap:base/client/ui/ci/star> \c3" @ %cl.name @ "\c6 is a donator!");
	}
	chatMessageClient(%cl, '', "You are now able to use /refreshDeal and /hat!");
	echo("Applied donator settings to " @ %cl.getPlayerName());
}

function applyBetaTesterSettings(%cl)
{
	%cl.isBetaTester = 1;
	messageAll('', "<bitmap:base/client/ui/ci/star> \c3" @ %cl.name @ "\c6 is a beta tester!");
}

function getDonatorMessage(%msg)
{
	%msg = stripMLControlChars(%msg);
	for (%i = 0; %i < getWordCount(%msg); %i++)
	{
		%word = getWord(%msg, %i);
		if (getSubStr(%word, 0, 7) $= "http://")
		{
			%url = stripChars(%word, "<>{}#|^");
			%urlFormat = "<a:" @ %url @ ">";
			%msg = setWord(%msg, %i, %urlFormat @ getSubStr(%word, 7, 1000) @ "</a>c6");
		}
		else if (getSubStr(%word, 0, 8) $= "https://")
		{
			%url = stripChars(%word, "<>{}#|^");
			%urlFormat = "<a:" @ %url @ ">";
			%msg = setWord(%msg, %i, %urlFormat @ getSubStr(%word, 8, 1000) @ "</a>\c6");
		}
	}
	return %msg;
}

function updateServerPlayerCount() {

	commandToAll('NewPlayerListGui_UpdateWindowTitle', $Pref::Server::Name, $Pref::Server::maxPlayers);
}

package Donators
{
	function serverCmdMissionStartPhase3Ack(%cl, %val) 
	{
		%cl.hasLoaded = 1;
		return parent::serverCmdMissionStartPhase3Ack(%cl, %val);
	}

	function GameConnection::onConnectRequest(%client, %netAddress, %LANname, %netName, %clanPrefix, %clanSuffix, %clientNonce) 
	{
		if (ClientGroup.getCount() == $Pref::Server::maxPlayers) 
		{
			$Pref::Server::maxPlayers++;
		} 
		else if (ClientGroup.getCount() > $Pref::Server::maxPlayers) 
		{
			$Pref::Server::maxPlayers = ClientGroup.getCount() + 1;
		}
		echo("\c4Attempt to join by \c3" @ %netName);
		return parent::onConnectRequest(%client, %netAddress, %LANname, %netName, %clanPrefix, %clanSuffix, %clientNonce);
	}

	function GameConnection::onDrop(%client) 
	{
		if ($Pref::Server::maxPlayers > $Farming::MaxPlayers) 
		{
			$Pref::Server::maxPlayers--;
			updateServerPlayerCount();
		}
		else if ($Pref::Server::maxPlayers > ClientGroup.getCount() && ClientGroup.getCount() > $Farming::MaxPlayers) 
		{
			$Pref::Server::maxPlayers = $Farming::MaxPlayers;
			updateServerPlayerCount();
		}
		return parent::onDrop(%client);
	}

	function servAuthTCPObj::onLine(%this, %line) 
	{
		%word = getWord(%line, 0);
		if (%word $= "SUCCESS")
		{
			%cl = %this.client;
			if (%cl.hasLoaded) 
			{
				return parent::onLine(%this, %line);
			}
			%blid = getWord(%line, 1);

			%isDonator = checkIfDonator(%blid);
			%isVIP = checkIfVIP(%blid);
			
			echo("Checking for VIP/donator status (" @ %blid @ ", " @ %cl.name @ ") " @ getDateTime());

			if (%isDonator || %isVIP)
			{
				echo("\c4    Attempt to join succeeded");
				echo("    VIP/donator status confirmed. Upping player limit...");
				%ret = parent::onLine(%this, %line);
				updateServerPlayerCount();
				webcom_postserver();
				pushServerName();
				return %ret;
			}

			if ($Pref::Server::maxPlayers > $Farming::MaxPlayers) 
			{
				echo("\c4    Attempt to join failed");
				%cl.isBanReject = 1;
				%cl.schedule(10, delete, "The server is full!");
				schedule(10, 0, eval, "$Pref::Server::maxPlayers--;");
				return;
			}

			//schedule(30, 0, updateServerPlayerCount);
		}
		else if (%word $= "NO")
		{
			return parent::onLine(%this, %line);
		}
		return parent::onLine(%this, %line);
	}

	function Player::mountImage(%obj, %img, %slot)
	{
		if (%obj.client.isDonator && isObject(%img.donatorImage) && %img.donatorImage.getID() != %img.getID())
		{
			return %obj.mountImage(%img.donatorImage, %slot);
		}
		return parent::mountImage(%obj, %img, %slot);
	}

	function serverCmdMessageSent(%cl, %msg)
	{
		return parent::serverCmdMessageSent(%cl, %msg);
	}

	function GameConnection::spawnPlayer(%cl)
	{
		%ret = parent::spawnPlayer(%cl);
		if (%cl.shapeNameColor !$= "")
		{
			%cl.player.setShapeNameColor(%cl.shapeNameColor);
		}
		if (%cl.isDonator && !%cl.hasSeenDonatorPrompt)
		{
			schedule(1000, %cl, commandToClient, %cl, 'messageBoxOK', "Donator!", "<just:left>                     <bitmap:base/client/ui/ci/star> <font:arial bold:24>Donator<font:arial:12> <bitmap:base/client/ui/ci/star>"
                @ " <br> <font:arial:16><just:center>Thank you for donating! You have access to /refreshDeal and /hat!");
			%cl.hasSeenDonatorPrompt = 1;
		}
		return %ret;
	}

	function serverCmdDropTool(%cl, %slot)
	{
		if (isObject(%pl = %cl.player) && isObject(%pl.tool[%slot].image.donatorImage))
		{
			for (%i = 0; %i < 4; %i++)
			{
				if (isObject((%img = %pl.getMountedImage(%i))) && %img.getID() == %pl.tool[%slot].image.donatorImage.getID())
				{
					%pl.unmountImage(%i);
				}
			}
		}
		return parent::serverCmdDropTool(%cl, %slot);
	}

	function GameConnection::autoAdminCheck(%cl)
	{
		%ret = parent::autoAdminCheck(%cl);

		if (checkIfDonator(%cl.bl_id))
		{
			schedule(100, %cl, applyDonatorSettings, %cl);
		}
		if (checkIfBetaTester(%cl.bl_id))
		{
			schedule(100, %cl, applyBetaTesterSettings, %cl);
		}

		return %ret;
	}

	function serverCmdHat(%cl, %a, %b, %c, %d, %e)
	{
		if (!%cl.canWearHats)
		{
			messageClient(%cl, '', "You must be a donator to wear hats!");
			return;
		}

		return parent::serverCmdHat(%cl, %a, %b, %c, %d, %e);
	}
};
schedule(1000, 0, activatePackage, Donators);

//donator images

//fertilizer
FertilizerBag0Image.donatorImage = GoldenFertilizerBag0Image;
FertilizerBag1Image.donatorImage = GoldenFertilizerBag1Image;
FertilizerBag2Image.donatorImage = GoldenFertilizerBag2Image;

datablock ShapeBaseImageData(GoldenFertilizerBag0Image : FertilizerBag0Image)
{
	colorShiftColor = "0.95 0.85 0 1";
	stateEmitter[1] = GoldenEmitter;
	stateEmitterTime[1] = 1000;
};

datablock ShapeBaseImageData(GoldenFertilizerBag1Image : FertilizerBag1Image)
{
	colorShiftColor = "0.95 0.85 0 1";
	stateEmitter[1] = GoldenEmitter;
	stateEmitterTime[1] = 1000;
};

datablock ShapeBaseImageData(GoldenFertilizerBag2Image : FertilizerBag2Image)
{
	colorShiftColor = "0.95 0.85 0 1";
	stateEmitter[1] = GoldenEmitter;
	stateEmitterTime[1] = 1000;
};


function GoldenFertilizerBag0Image::onFire(%this, %obj, %slot)
{
	fertilizeCrop(%this, %obj, %slot);
}

function GoldenFertilizerBag1Image::onFire(%this, %obj, %slot)
{
	fertilizeCrop(%this, %obj, %slot);
}

function GoldenFertilizerBag2Image::onFire(%this, %obj, %slot)
{
	fertilizeCrop(%this, %obj, %slot);
}



function GoldenFertilizerBag0Image::onLoop(%this, %obj, %slot)
{
	fertilizerLoop(%this, %obj);
}

function GoldenFertilizerBag1Image::onLoop(%this, %obj, %slot)
{
	fertilizerLoop(%this, %obj);
}

function GoldenFertilizerBag2Image::onLoop(%this, %obj, %slot)
{
	fertilizerLoop(%this, %obj);
}

//planter
PlanterImage.donatorImage = GoldenPlanterImage;
PlanterV2Image.donatorImage = GoldenPlanterV2Image;

datablock ShapeBaseImageData(GoldenPlanterImage : PlanterImage)
{
	colorShiftColor = "1 0.95 0.3 1";
	stateEmitter[1] = GoldenEmitter;
	stateEmitterTime[1] = 1000;
};

datablock ShapeBaseImageData(GoldenPlanterV2Image : PlanterV2Image)
{
	colorShiftColor = "0.95 0.85 0.5 1";
	stateEmitter[1] = GoldenEmitter;
	stateEmitterTime[1] = 1000;
};

function GoldenPlanterImage::onLoop(%this, %obj, %slot)
{
	PlanterImage::onLoop(%this, %obj, %slot);
}

function GoldenPlanterImage::onFire(%this, %obj, %slot)
{
	PlanterImage::onFire(%this, %obj, %slot);
}

function GoldenPlanterV2Image::onLoop(%this, %obj, %slot)
{
	PlanterV2Image::onLoop(%this, %obj, %slot);
}

function GoldenPlanterV2Image::onFire(%this, %obj, %slot)
{
	PlanterImage::onFire(%this, %obj, %slot);
}

//watering can
WateringCanImage.donatorImage = GoldenWateringCanImage;
WateringCan2Image.donatorImage = GoldenWateringCan2Image;
WateringCan3Image.donatorImage = GoldenWateringCan3Image;
HoseImage.donatorImage = GoldenHoseImage;
HoseV2Image.donatorImage = GoldenHoseV2Image;

datablock ShapeBaseImageData(GoldenWateringCanImage : WateringCanImage)
{
	colorShiftColor = "0.95 0.85 0 1";
	stateEmitter[1] = GoldenEmitter;
	stateEmitterTime[1] = 1000;

	stateEmitter[3] = GoldenEmitter;
	stateEmitterTime[3] = 1000;
};

datablock ShapeBaseImageData(GoldenWateringCan2Image : WateringCan2Image)
{
	colorShiftColor = "0.95 0.85 0 1";
	stateEmitter[1] = GoldenEmitter;
	stateEmitterTime[1] = 1000;

	stateEmitter[3] = GoldenEmitter;
	stateEmitterTime[3] = 1000;
};

datablock ShapeBaseImageData(GoldenWateringCan3Image : WateringCan3Image)
{
	colorShiftColor = "0.95 0.85 0 1";
	stateEmitter[1] = GoldenEmitter;
	stateEmitterTime[1] = 1000;

	stateEmitter[3] = GoldenEmitter;
	stateEmitterTime[3] = 1000;
};

datablock ShapeBaseImageData(GoldenHoseImage : HoseImage)
{
	colorShiftColor = "1 0.95 0.3 1";
	stateEmitter[1] = GoldenEmitter;
	stateEmitterTime[1] = 1000;

	stateEmitter[3] = GoldenEmitter;
	stateEmitterTime[3] = 1000;
};

datablock ShapeBaseImageData(GoldenHoseV2Image : HoseV2Image)
{
	colorShiftColor = "0.95 0.85 0.5 1";
	stateEmitter[1] = GoldenEmitter;
	stateEmitterTime[1] = 1000;

	stateEmitter[3] = GoldenEmitter;
	stateEmitterTime[3] = 1000;
};

function GoldenWateringCanImage::onFire(%this, %obj, %slot)
{
	waterCanFire(%this, %obj, %slot);
}

function GoldenWateringCan2Image::onFire(%this, %obj, %slot)
{
	waterCanFire(%this, %obj, %slot);
}

function GoldenWateringCan3Image::onFire(%this, %obj, %slot)
{
	waterCanFire(%this, %obj, %slot);
}

function GoldenHoseImage::onFire(%this, %obj, %slot)
{
	waterCanFire(%this, %obj, %slot);
}

function GoldenHoseV2Image::onFire(%this, %obj, %slot)
{
	waterCanFire(%this, %obj, %slot);
}

function GoldenWateringCanImage::onReady(%this, %obj, %slot)
{
	wateringCanReady(%this, %obj, %slot);
}

function GoldenWateringCan2Image::onReady(%this, %obj, %slot)
{
	wateringCanReady(%this, %obj, %slot);
}

function GoldenWateringCan3Image::onReady(%this, %obj, %slot)
{
	wateringCanReady(%this, %obj, %slot);
}

function GoldenHoseImage::onReady(%this, %obj, %slot)
{
	wateringCanReady(%this, %obj, %slot);
}

function GoldenHoseV2Image::onReady(%this, %obj, %slot)
{
	wateringCanReady(%this, %obj, %slot);
}



//harvest tools
TrowelImage.donatorImage = GoldenTrowelImage;
ClipperImage.donatorImage = GoldenClipperImage;
HoeImage.donatorImage = GoldenHoeImage;
SickleImage.donatorImage = GoldenSickleImage;

datablock ShapeBaseImageData(GoldenTrowelImage : TrowelImage)
{
	colorShiftColor = "0.95 0.85 0 1";
	stateEmitter[1] = GoldenEmitter;
	stateEmitterTime[1] = 1000;

	stateEmitter[3] = GoldenEmitter;
	stateEmitterTime[3] = 1000;
};

datablock ShapeBaseImageData(GoldenClipperImage : ClipperImage)
{
	colorShiftColor = "0.95 0.85 0 1";
	stateEmitter[1] = GoldenEmitter;
	stateEmitterTime[1] = 1000;

	stateEmitter[3] = GoldenEmitter;
	stateEmitterTime[3] = 1000;
};

datablock ShapeBaseImageData(GoldenHoeImage : HoeImage)
{
	colorShiftColor = "0.95 0.85 0 1";
	stateEmitter[1] = GoldenEmitter;
	stateEmitterTime[1] = 1000;

	stateEmitter[3] = GoldenEmitter;
	stateEmitterTime[3] = 1000;
};

datablock ShapeBaseImageData(GoldenSickleImage : SickleImage)
{
	colorShiftColor = "0.95 0.85 0 1";
	stateEmitter[1] = GoldenEmitter;
	stateEmitterTime[1] = 1000;

	stateEmitter[3] = GoldenEmitter;
	stateEmitterTime[3] = 1000;
};